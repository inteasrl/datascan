import{hb as z,aG as k,aF as T}from"./dati-Cpx6sRLW.js";import{i as $}from"./CIMResourceManager-DwIyiNIw.js";import{a as G,h as j,u as q}from"./UpdateTracking2D-CQdgdUGs.js";import{v as A}from"./OverrideHelper-BQyCd-t0.js";import{T as S,R as D}from"./rasterizingUtils-A0q3LN-3.js";import"./style--gkYsyr-.js";import"./BidiEngine-QXap_35O.js";import"./OptimizedFeature-1gD0DaRG.js";import"./memoryEstimations-xiOOEvy2.js";import"./GeometryUtils-DXAJQfpe.js";import"./Rect-CUzevAry.js";import"./Utils-QtsI1YGo.js";import"./VertexElementDescriptor-BLyltQyJ.js";import"./colorUtils-2vuFA9_3.js";import"./quantizationUtils-DZSRKs-y.js";import"./floatRGBA-Dxf0S6kL.js";const B=96/72;class rt{constructor(o){this._spatialReference=o,this._imageDataCanvas=null,this._cimResourceManager=new $}get _canvas(){return this._imageDataCanvas||(this._imageDataCanvas=document.createElement("canvas")),this._imageDataCanvas}get resourceManager(){return this._cimResourceManager}async rasterizeCIMSymbolAsync(o,n,m,R,I,s,c,l,d,x){if(!o)return null;const{data:w}=o;if(!w||w.type!=="CIMSymbolReference"||!w.symbol)return null;const{symbol:v}=w;s||(s=z(v));const a=await A.resolveSymbolOverrides(w,n,this._spatialReference,I,s,c,l),u=this._cimResourceManager,b=[];G.fetchResources(a,u,b),G.fetchFonts(a,u,b),b.length>0&&await Promise.all(b);const{width:e,height:h}=m;let y=E(s,e,h,R,x);const t=G.getEnvelope(a,y,u);if(!t)return null;t.x===1/0&&(t.x=e+2),t.y===1/0&&(t.y=-h/2),t.width===-1/0&&(t.width=e),t.height===-1/0&&(t.height=h);let g=1,_=0,C=0;switch(v.type){case"CIMPointSymbol":case"CIMTextSymbol":{let i=1;t.width>e&&(i=e/t.width);let r=1;t.height>h&&(r=h/t.height),R==="preview"&&(t.width<e&&(i=e/t.width),t.height<h&&(r=h/t.height)),g=Math.min(i,r),_=t.x+t.width/2,C=t.y+t.height/2}break;case"CIMLineSymbol":if(x){C=t.y+t.height/2,_=t.x+t.width/2;const i=t.width-e,r=t.height-h;y={paths:S(y.paths,{xmin:-1*t.width/2+i,xmax:t.width/2-i,ymin:-1*t.height/2+r,ymax:t.height/2-r,width:t.width-2*i,height:t.height-2*r})}}else{(d||t.height>h)&&(g=h/t.height),C=t.y+t.height/2;const i=t.x*g+e/2,r=(t.x+t.width)*g+e/2,M=k(y)?y.paths:T(y)?y.rings:null;if(M===null)throw new Error("Bad geometry, can't rasterise symbol!");M[0][0][0]-=i/g,M[0][2][0]-=(r-e)/g}break;case"CIMPolygonSymbol":if(x){C=t.y+t.height/2,_=t.x+t.width/2;const i=t.width-e,r=t.height-h;y={paths:S(y.rings,{xmin:-1*t.width/2+i,xmax:t.width/2-i,ymin:-1*t.height/2+r,ymax:t.height/2-r,width:t.width-2*i,height:t.height-2*r})}}else{_=t.x+t.width/2,C=t.y+t.height/2;const i=t.x*g+e/2,r=(t.x+t.width)*g+e/2,M=t.y*g+h/2,P=(t.y+t.height)*g+h/2,{rings:p}=y;i<0&&(p[0][0][0]-=i,p[0][3][0]-=i,p[0][4][0]-=i),M<0&&(p[0][0][1]+=M,p[0][1][1]+=M,p[0][4][1]+=M),r>e&&(p[0][1][0]-=r-e,p[0][2][0]-=r-e),P>h&&(p[0][2][1]+=P-h,p[0][3][1]+=P-h)}}const F={type:"cim",data:{type:"CIMSymbolReference",symbol:a}};return this.rasterize(F,e,h,_,C,g,s,1,y)}rasterize(o,n,m,R,I,s,c,l=0,d=null,x=window.devicePixelRatio||1){const{data:w}=o;if(!w||w.type!=="CIMSymbolReference"||!w.symbol)return null;const{symbol:v}=w,a=this._canvas,u=x*B;a.width=n*u,a.height=m*u,c||(c=z(v)),d||(d=E(c,n,m,"legend")),a.width+=2*l,a.height+=2*l;const b=a.getContext("2d",{willReadFrequently:!0}),e=j.createIdentity();return e.translate(-R,-I),e.scale(s*u,-s*u),e.translate(n*u/2+l,m*u/2+l),b.clearRect(0,0,a.width,a.height),new q(b,this._cimResourceManager,e,!0).drawSymbol(v,d),b.getImageData(0,0,a.width,a.height)}}function L(f,o,n,m){return o==="esriGeometryPolygon"?{rings:D(S(f.rings,{xmin:0,ymin:0,width:n,height:m}),-1*n/2,-1*m/2)}:o==="esriGeometryPolyline"?{paths:D(S(f.paths,{xmin:0,ymin:0,width:n,height:m}),-1*n/2,-1*m/2)}:null}function E(f,o,n,m,R){const s=-o/2+1,c=o/2-1,l=n/2-1,d=-n/2+1;if(R&&(f==="esriGeometryPolygon"||f==="esriGeometryPolyline")){const x=L(R,f,o,n);if(x)return x}switch(f){case"esriGeometryPoint":return{x:0,y:0};case"esriGeometryPolyline":return{paths:[[[s,0],[0,0],[c,0]]]};default:return m==="legend"?{rings:[[[s,l],[c,0],[c,d],[s,d],[s,l]]]}:{rings:[[[s,l],[c,l],[c,d],[s,d],[s,l]]]}}}export{rt as CIMSymbolRasterizer};
